//canvas
const canvas = document.getElementById('js-canvas')
canvas.width = 640;
canvas.height = 640;
let ctx = canvas.getContext('2d');

//アイコン
let icon = new Object();
icon.img = new Image();
//railsで書き換えすること
icon.img.src = '/assets/vimmer_01_vimuta.png'
//vimuta初期値
icon.x = 0;
icon.y = 0;
icon.move = 0;

//ブロック
let block = new Image();
block.src = '/assets/vimmer_01_map.png'

//マップ 1がblock
const map = [
	[0, 0, 1, 0, 1, 0, 0, 0 ,0 ,1 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,1 ,0],
	[0, 1, 0, 0, 0, 1, 1, 1 ,0 ,1 ,0 ,1 ,1 ,0 ,1 ,1 ,1 ,0 ,1 ,0],
	[0, 0, 1, 1, 0, 0, 0, 1 ,0 ,0 ,0 ,1 ,0 ,0 ,0 ,1 ,0 ,0 ,0 ,0],
	[1, 0, 1, 0, 1, 1, 0, 0 ,0 ,1 ,1 ,1 ,1 ,1 ,0 ,0 ,1 ,0 ,1 ,0],
	[0, 0, 0, 0, 0, 1, 1, 1 ,0 ,1 ,0 ,0 ,0 ,0 ,1 ,1 ,0 ,1 ,1 ,0],
	[0, 1, 1, 1, 0, 0, 0, 0 ,0 ,1 ,0 ,1 ,1 ,1 ,0 ,1 ,0 ,0 ,0 ,0],
	[0, 1, 1, 1, 0, 1, 1, 1 ,1 ,1 ,0 ,1 ,0 ,0 ,0 ,0 ,1 ,1 ,1 ,0],
	[0, 0, 0, 1, 0, 0, 0, 0 ,1 ,0 ,0 ,1 ,0 ,1 ,1 ,0 ,0 ,0 ,1 ,0],
	[1, 1, 0, 1, 1, 1, 1, 1 ,1 ,0 ,1 ,1 ,0 ,0 ,1 ,1 ,1 ,0 ,1 ,1],
	[1, 0, 0, 0, 0, 0, 1, 1 ,0 ,0 ,0 ,0 ,1 ,0 ,1 ,1 ,0 ,0 ,1 ,0],
	[1, 0, 1, 1, 1, 0, 0, 0 ,1 ,0 ,1 ,0 ,0 ,0 ,0 ,0 ,1 ,1 ,0 ,0],
	[1, 0, 1, 0, 1, 1, 1, 0 ,1 ,0 ,1 ,1 ,0 ,1 ,1 ,0 ,0 ,0 ,0 ,1],
	[0, 0, 1, 0, 0, 1, 0, 0 ,1 ,0 ,0 ,1 ,0 ,1 ,0 ,1 ,1 ,1 ,0 ,0],
	[0, 1, 1, 1, 0, 1, 0, 1 ,0 ,0 ,1 ,1 ,0 ,1 ,0 ,1 ,1 ,0 ,1 ,0],
	[0, 0, 0, 1, 0, 1, 0, 0 ,1 ,0 ,1 ,1 ,0 ,1 ,0 ,0 ,0 ,0 ,0 ,0],
	[1, 1, 0, 1, 0, 1, 0, 1 ,1 ,0 ,0 ,1 ,0 ,1 ,1 ,0 ,1 ,1 ,1 ,0],
	[0, 0, 0, 1, 0, 1, 1, 1 ,1 ,1 ,0 ,1 ,0 ,1 ,1 ,0 ,0 ,0 ,1 ,0],
	[0, 1, 1, 1, 0, 1, 0, 0 ,0 ,0 ,0 ,1 ,0 ,0 ,0 ,1 ,1 ,0 ,1 ,1],
	[0, 1, 0, 0, 0, 1, 0, 1 ,1 ,1 ,0 ,0 ,1 ,1 ,0 ,1 ,0 ,0 ,0 ,0],
	[0, 0, 0, 1, 0, 0, 0, 1 ,1 ,1 ,1 ,0 ,0 ,0 ,1 ,1 ,1 ,1 ,1 ,0]
]

//キーボード
let key = new Object();
key.up = false;
key.down = false;
key.right = false;
key.left = false;
key.push = '';
const valid_keys = ['h', 'j', 'k', 'l'];

function main() {
  ctx.fillStyle = '#f5f5f5';
  ctx.fillRect(0, 0, 640, 640);
  for (let mapy=0; mapy < map.length; mapy++) {
    for (let mapx=0; mapx < map[mapy].length; mapx++) {
			if ( map[mapy][mapx] === 1 ) ctx.drawImage( block, 32*mapx, 32*mapy);
    }
  }
  ctx.drawImage(icon.img, icon.x, icon.y);

  addEventListener('keydown', keydownfunc, false);
  addEventListener('keyup', keyupfunc, false);

  if (icon.move === 0) {
    if (key.left === true) {
      x = icon.x/32;
      y = icon.y/32;
      x--;
      if (map[y][x] === 0) {
        icon.move = 32;
        key.push = 'left';
      }
    }
    if (key.up === true) {
      x = icon.x/32;
      y = icon.y/32;
      if (y > 0) {
        y--;
        if (map[y][x] === 0) {
          icon.move = 32;
          key.push = 'up';
        }
      }
    }
    if (key.right === true) {
      x = icon.x/32;
      y = icon.y/32;
      x++;
      if (map[y][x] === 0) {
        icon.move = 32;
        key.push = 'right';
      }
    }
    if (key.down === true) {
      x = icon.x/32;
      y = icon.y/32;
      debugger;
      if (y < 19) {
        y++;
        if (map[x][y] === 0) {
          icon.move = 32;
          key.push = 'down';
        }
      }
    }
  }

  if (icon.move > 0) {
    icon.move -= 4;
    if (key.push === 'left') icon.x -= 4;
    if (key.push === 'up') icon.y -= 4;
    if (key.push === 'right') icon.x += 4;
    if (key.push === 'down') icon.y += 4;
  }

  requestAnimationFrame(main);
}

function keydownfunc(event) {
  if (!valid_keys.includes(event.key)) return;
  if (event.key === 'h') key.left = true;
  if (event.key === 'k') key.up = true;
  if (event.key === 'l') key.right = true;
  if (event.key === 'j') key.down = true;
  event.preventDefault();
}

function keyupfunc(event) {
  if (!valid_keys.includes(event.key)) return;
  if (event.key === 'h') key.left = false;
  if (event.key === 'k') key.up = false;
  if (event.key === 'l') key.right = false;
  if (event.key === 'j') key.down = false;
}

addEventListener('load', main(), false);
